# BeatU 需求文档

## 第一部分：技术架构设计方案

针对短视频应用“高流量、低延迟、强交互”的特点，建议采用现代化的 Android 开发架构。

### 1.1 总体架构模式

推荐采用 **MVVM (Model-View-ViewModel)** 架构配合 **Android Jetpack** 组件库。

- **UI 层 (View)**  
  负责展示界面和处理用户手势（点击、滑动）。建议使用 `Activity`（主容器）+ `Fragment`（Tab页）的结构。

- **逻辑层 (ViewModel)**  
  持有 UI 状态（如视频列表数据、播放状态），处理业务逻辑，不直接持有 View 引用，避免内存泄漏。

- **数据层 (Model/Repository)**  
  负责从网络 API 获取视频数据或读取本地缓存。

### 1.2 核心技术选型

| 模块         | 推荐技术                   | 理由                                                                 |
|--------------|----------------------------|----------------------------------------------------------------------|
| 编程语言     | Kotlin                     | Android 官方首选；协程 (Coroutines) 处理异步任务更优雅               |
| 视频播放器   | ExoPlayer (Media3)         | Google 官方维护，扩展性强，支持缓存、自适应流 (HLS/DASH)，社区支持最好 |
| 列表/滑动流  | ViewPager2                 | 对页面生命周期管理更好，原生支持竖向滑动翻页                         |
| 图片加载     | Glide 或 Coil              | 加载视频封面图/用户头像；Coil 纯 Kotlin，更轻量                       |
| 网络请求     | Retrofit + OkHttp          | 行业标准，配合 Gson/Moshi 解析 JSON                                  |
| 依赖注入     | Hilt                       | 降低模块耦合度，便于测试和维护                                       |

### 1.3 关键技术难点与解决方案

#### A. 视频流核心实现 (ViewPager2 vs RecyclerView)

- **方案**：使用 `ViewPager2`，设置 `orientation = VERTICAL`  
- **原理**：每个 Item 是一个全屏的 Fragment 或 View  
- **优化**：
  - **播放器复用**：全局复用**一个播放器实例**，或维护一个**3实例缓存池**，滑动时将播放器 View 动态 `attach` 到当前 Item 上。

#### B. 秒开与流畅度 (性能优化)

- **预加载 (Pre-loading)**  
  用户看第 N 个视频时，后台静默下载第 N+1 个视频的前 1–2MB 数据。ExoPlayer 提供 `CacheDataSource` 支持边下边播和预缓存。

- **封面图策略**  
  视频未加载完成前先显示首帧封面图，播放器 `onReady` 后再隐藏，实现无缝视觉体验。

- **内存管理**  
  划出屏幕的视频必须立即 **pause 或 release**，防止 OOM。

---

## 第二部分：产品需求文档 (PRD)

### 2.1 功能概述

#### 2.1.1 业务流程图

描述用户从打开 App → 观看视频 → 滑动切换 → 点赞交互的核心流程。

#### 2.1.2 功能架构

涵盖：  
- 导航层  
- 视频播放核心层  
- 用户交互层

---

### 2.2 详细功能需求

#### 2.2.1 App 启动与内容流加载

##### 2.2.1.1 业务流程
1. 用户打开 App  
2. 成功加载视频流  
3. 当前视频自动播放  
4. 用户上/下滑动  
5. 切换到下/上一个视频  
6. 离屏视频资源释放，新视频预加载  

##### 2.2.1.2 逻辑说明

| 元素/交互   | 逻辑说明                                                                 |
|-------------|--------------------------------------------------------------------------|
| 启动流程    | Logo → 加载动画 → 内容展示                                               |
| 导航栏      | 底部/顶部导航栏；Tab 点击切换页面                                       |
| 加载策略    | 视频流**立即加载**；导航栏等非核心 UI 元素**懒加载**                    |

---

#### 2.2.2 视频交互（点赞/评论/收藏/分享）

##### 2.2.2.1 业务流程
- 用户点击底部交互元素  
- 触发对应操作  
- 给予即时、明确的视觉反馈  

##### 2.2.2.3 业务逻辑

| 元素/交互 | 逻辑说明 |
|-----------|---------|
| **点赞/取消** | - 操作：点击爱心图标或双击屏幕<br>- 反馈：爱心变红 + 屏幕中央红心动画（乐观 UI）<br>- 取消：再点变白 |
| **关注/取消** | - 关注：加号 → 对勾；头像点击进入主页显示“已关注”<br>- 取消：头像页点击“取消关注” |
| **评论** | - 点击评论按钮 → 视频缩小至屏幕上方，评论区半屏弹出<br>- 输入后发布，评论显示在顶部<br>- `@元宝` AI 可根据视频内容自动问答 |
| **收藏** | - 点亮图标 + “收藏成功”提示；存入收藏栏<br>- 取消：图标熄灭 + 提示，移出收藏栏 |
| **分享** | - 弹出浮层：<br>  &nbsp;&nbsp;✓ 复制链接<br>  &nbsp;&nbsp;✓ 保存带二维码图片（扫码观看） |

---

#### 2.2.3 核心手势与播控

##### 2.2.3.1 业务流程
用户在播放界面执行手势（单击、滑动、长按横滑）→ 系统触发播控操作 → 播放器状态变化

##### 2.2.3.3 业务逻辑

| 元素/交互 | 逻辑说明 |
|-----------|---------|
| **单击暂停/播放** | 非交互区域单击 → 暂停/播放；中间显示半透明白色暂停符 |
| **上下滑动切换** | 无缝切换：当前视频继续播，下一视频进入主屏后自动续播 |
| **左右滑动** | 切换关注/推荐/主页频道；支持**不停播切换** |
| **进度条拉取 (Seek)** | 红框内长按 + 左右滑动：<br> - UI 清屏，中央显示大进度条+时间<br> - 松手后恢复 |
| **刷新** | - 首页 Tab 双击刷新<br> - 上滑也可刷新；Tab 有动画反馈 |
| **倍速播放** | 长按状态下：<br> - 左右滑：0.5× / 2.0× / 3.0×<br> - 下滑到底：设为**默认倍速** |

---

#### 2.2.4 主页展示

##### 2.2.4.1 业务流程
- 点/滑 → 个人主页：展示头像、社交信息、作品/收藏/点赞/历史  
- 点创作者头像 → 博主主页（含“是否关注”状态）

##### 2.2.4.3 业务逻辑

| 元素/交互 | 逻辑说明 |
|-----------|---------|
| **个人主页** | 点“我的”/右滑进入；含作品、点赞、收藏列表等 |
| **博主主页** | 首页点作者头像进入；含关注按钮、作品列表等 |

---

#### 2.2.5 横屏模式交互 (Landscape Mode)

##### 2.2.5.1 业务流程
1. 用户点击“全屏”按钮 或 旋转设备（视频为横屏时）→ 进入横屏模式  
2. 强制 `LANDSCAPE`，全屏播放器 + 横屏 UI 覆盖层  
3. 复杂手势：亮度/音量/进度调节  
4. 可加锁防误触  
5. 点“退出全屏”或旋转 → 返回竖屏，进度保留  

##### 2.2.5.3 业务逻辑

| 元素/交互 | 逻辑说明 |
|-----------|---------|
| **触发方式** | ① 点“全屏”按钮<br>② 视频元数据为横屏 + 用户旋转设备 |
| **退出竖屏** | 左上角“退出全屏”按钮；进度不丢失 |
| **上下滑** | 查看上/下一个**支持横屏的视频** |
| **单击** | 显/隐控制按钮 |
| **双击** | 暂停/播放（**无图标提示**） |
| **点赞/收藏** | 单击点亮图标；逻辑同竖屏 |
| **评论/分享** | 弹出横屏适配半屏/浮层 |
| **倍速/清晰度** | 点击弹菜单：<br>- 倍速：1.0x / 1.25x / 1.5x / 2.0x<br>- 清晰度：自动 / 高清 / 标清 |
| **防误触锁** | 点“锁屏”按钮 → 锁定所有 UI/手势，仅留解锁按钮 |
| **亮度调节** | 右侧亮度按钮 **长按+上/下滑** → 亮度增/减；左侧显示亮度条 |
| **音量调节** | 右侧音量按钮 **长按+上/下滑** → 音量增/减；右侧显示音量条 |
| **进度快进/退** | 屏幕任意处 **水平滑动**：<br>- 左滑：快进<br>- 右滑：快退<br>- 中央显示时间+进度条 |
| **2X 快速播放** | 屏幕中央长按 → 进入 2 倍速；松手恢复 |

---

### 2.3 非功能性需求 (NFR)

| 类别       | 要求                                                                 |
|------------|----------------------------------------------------------------------|
| **流畅度** | - FPS 55~60，无卡顿<br>- 视频首帧 < 500ms（依赖预加载）              |
| **兼容性** | 适配全面屏（18:9, 20:9）                                            |
| **横竖屏** | 默认竖屏；横屏视频 + 旋转 → 自动全屏横屏（需调研 ExoPlayer `ResizeMode`） |
| **网络**   | - 弱网：自动切低清/提示<br>- 断网：展示 Retry 页面                  |

