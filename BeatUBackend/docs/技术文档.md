# BeatU Backend 技术文档

## 1. 架构概述

BeatU Backend 是一个基于 FastAPI 的 RESTful API 服务，采用模块化单体架构设计，负责为 BeatU 客户端提供视频内容、互动、评论、AI 推荐和观测性能力。

### 1.1 架构图

```
┌─────────────┐
│   Client    │
│  (Android)  │
└──────┬──────┘
       │ HTTP/REST
       ▼
┌─────────────────────────────────────┐
│      BeatU Backend (FastAPI)        │
│  ┌───────────────────────────────┐  │
│  │   Routes Layer               │  │
│  │  - videos.py                 │  │
│  │  - ai.py                     │  │
│  │  - metrics.py                │  │
│  └───────────┬───────────────────┘  │
│              │                       │
│  ┌───────────▼───────────────────┐  │
│  │   Services Layer              │  │
│  │  - VideoService              │  │
│  │  - CommentService            │  │
│  │  - AIService                 │  │
│  │  - MetricsService            │  │
│  └───────────┬───────────────────┘  │
│              │                       │
│  ┌───────────▼───────────────────┐  │
│  │   Database Layer              │  │
│  │  - SQLAlchemy ORM             │  │
│  │  - MySQL / SQLite             │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

### 1.2 核心模块

- **Routes Layer（路由层）**：处理 HTTP 请求，参数验证，响应格式化
- **Services Layer（服务层）**：业务逻辑处理，数据转换
- **Database Layer（数据层）**：ORM 模型定义，数据库操作
- **Schemas Layer（模式层）**：API 请求/响应数据模型定义

## 2. 技术栈

### 2.1 核心技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.11+ | 编程语言 |
| FastAPI | 0.115.0 | Web 框架 |
| SQLAlchemy | 2.0.36 | ORM 框架 |
| Pydantic | 1.10.15 | 数据验证和序列化 |
| Uvicorn | 0.30.0 | ASGI 服务器 |
| PyMySQL | 1.1.1 | MySQL 驱动 |

### 2.2 数据库

- **主数据库**：MySQL 8.x（生产环境）或 SQLite（开发环境）
- **缓存**：Redis 5.0.8（已配置，当前功能未强制依赖）

### 2.3 开发工具

- **测试框架**：pytest 8.3.3
- **环境管理**：python-dotenv 1.0.1

## 3. 项目结构

```
BeatUBackend/
├── main.py                 # FastAPI 应用入口
├── core/                   # 核心配置
│   ├── config.py          # 配置管理
│   ├── exceptions.py      # 异常处理
│   └── security.py         # 安全相关
├── routes/                 # 路由层
│   ├── videos.py          # 视频相关接口
│   ├── ai.py              # AI 相关接口
│   └── metrics.py         # 指标上报接口
├── services/               # 服务层
│   ├── video_service.py   # 视频业务逻辑
│   ├── comment_service.py # 评论业务逻辑
│   ├── ai_service.py      # AI 业务逻辑
│   ├── metrics_service.py # 指标业务逻辑
│   └── helpers.py         # 工具函数
├── database/               # 数据层
│   ├── models.py          # ORM 模型定义
│   ├── connection.py      # 数据库连接
│   └── init_db.py         # 数据库初始化
├── schemas/                # 数据模式
│   └── api.py             # API 请求/响应模型
└── tests/                  # 测试代码
    └── test_video_service.py
```

## 4. 数据库设计

### 4.1 核心表结构

#### 4.1.1 videos（视频表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String(64) | 主键，视频唯一标识 |
| play_url | String(500) | 播放地址 |
| cover_url | String(500) | 封面地址 |
| title | String(200) | 视频标题 |
| tags | JSON | 标签列表 |
| duration_ms | BigInteger | 时长（毫秒） |
| orientation | Enum | 方向：PORTRAIT/LANDSCAPE |
| author_id | String(64) | 作者 ID |
| author_name | String(100) | 作者名称 |
| author_avatar | String(500) | 作者头像 |
| like_count | BigInteger | 点赞数 |
| comment_count | BigInteger | 评论数 |
| favorite_count | BigInteger | 收藏数 |
| share_count | BigInteger | 分享数 |
| view_count | BigInteger | 播放数 |
| qualities | JSON | 多码率信息 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

#### 4.1.2 comments（评论表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| video_id | String(64) | 外键，视频 ID |
| author_id | String(64) | 评论者 ID |
| author_name | String(100) | 评论者名称 |
| author_avatar | String(500) | 评论者头像 |
| content | Text | 评论内容 |
| parent_id | Integer | 父评论 ID（回复） |
| is_ai_reply | Boolean | 是否为 AI 回复 |
| ai_model | String(64) | AI 模型标识 |
| ai_source | String(32) | AI 来源 |
| ai_confidence | Float | AI 置信度 |
| like_count | BigInteger | 点赞数 |
| created_at | DateTime | 创建时间 |

#### 4.1.3 interactions（互动表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| user_id | String(64) | 用户 ID（索引） |
| video_id | String(64) | 视频 ID（外键） |
| author_id | String(64) | 作者 ID |
| type | Enum | 类型：LIKE/FAVORITE/FOLLOW_AUTHOR |
| created_at | DateTime | 创建时间 |

**唯一约束**：
- `(user_id, video_id, type)` - 防止重复点赞/收藏
- `(user_id, author_id, type)` - 防止重复关注

#### 4.1.4 metrics_playback（播放指标表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| video_id | String(64) | 视频 ID |
| fps | Float | 平均帧率 |
| start_up_ms | BigInteger | 首帧时间（毫秒） |
| rebuffer_count | Integer | 卡顿次数 |
| memory_mb | Float | 内存使用（MB） |
| channel | String(32) | 频道标识 |
| created_at | DateTime | 创建时间 |

#### 4.1.5 metrics_interaction（互动指标表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| event | String(64) | 事件类型 |
| video_id | String(64) | 视频 ID |
| latency_ms | BigInteger | 延迟（毫秒） |
| success | Boolean | 是否成功 |
| created_at | DateTime | 创建时间 |

### 4.2 索引设计

- `videos.author_id` - 索引，用于按作者查询
- `interactions.user_id` - 索引，用于查询用户互动
- `interactions.video_id` - 外键索引，用于查询视频互动

## 5. 配置管理

### 5.1 环境变量

通过 `.env` 文件或环境变量配置：

```bash
# 数据库配置
DATABASE_URL=mysql+pymysql://root:password@localhost:3306/beatu_content

# Redis 配置（可选）
REDIS_URL=redis://localhost:6379/0

# API 密钥
API_KEY=your-api-key

# 调试模式
DEBUG=false
```

### 5.2 默认配置

- **数据库**：`mysql+pymysql://root:2218502641@localhost:3306/beatu_content`
- **Redis**：`redis://localhost:6379/0`
- **API 密钥**：`dev-key`

## 6. 认证与授权

### 6.1 当前实现

- 使用 HTTP Header `X-User-Id` 和 `X-User-Name` 进行临时用户识别
- 默认用户：`demo-user` / `BeatU 用户`

### 6.2 未来扩展

- 支持 JWT Token 认证
- 支持 OAuth 2.0 / OIDC
- 支持设备指纹识别

## 7. 错误处理

### 7.1 错误码定义

| 错误码 | 说明 | HTTP 状态码 |
|--------|------|-------------|
| 0 | 成功 | 200 |
| 1001 | 鉴权失败 | 401 |
| 2001 | 资源不存在 | 404 |
| 2002 | 互动状态冲突 | 409 |
| 3001 | AI 服务不可用 | 503 |
| 5000 | 服务器内部错误 | 500 |

### 7.2 响应格式

```json
{
  "code": 0,
  "message": "OK",
  "data": {}
}
```

## 8. 性能优化

### 8.1 数据库优化

- 使用索引加速查询
- 批量查询减少数据库往返
- 使用连接池管理数据库连接

### 8.2 缓存策略

- Redis 缓存 Feed 列表（待实现）
- Redis 缓存用户互动状态（待实现）

### 8.3 性能目标

- Feed 接口 P95 < 200ms
- 互动接口 P95 < 300ms
- AI 推荐接口 P95 < 500ms

## 9. 部署说明

### 9.1 本地开发

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 初始化数据库
python -m database.init_db --drop

# 3. 启动服务
uvicorn main:app --reload
```

### 9.2 生产部署

```bash
# 使用 Gunicorn + Uvicorn Workers
gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 9.3 Docker 部署（待实现）

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

## 10. 监控与日志

### 10.1 日志

- 使用 Python logging 模块
- 建议接入结构化日志（JSON 格式）
- 日志级别：DEBUG / INFO / WARNING / ERROR

### 10.2 指标采集

- 播放指标：通过 `/api/metrics/playback` 接口上报
- 互动指标：通过 `/api/metrics/interaction` 接口上报
- 服务指标：建议接入 Prometheus + Grafana

## 11. 安全考虑

### 11.1 已实现

- 参数验证（Pydantic）
- SQL 注入防护（SQLAlchemy ORM）
- 唯一约束防止重复操作

### 11.2 待实现

- HTTPS 强制
- 请求限流
- 日志脱敏
- CORS 配置
- 输入内容过滤（防 XSS）

## 12. 扩展性

### 12.1 水平扩展

- 无状态设计，支持多实例部署
- 数据库连接池支持
- 建议使用负载均衡器（Nginx / HAProxy）

### 12.2 功能扩展

- 支持视频上传/转码（待实现）
- 支持用户系统（待实现）
- 支持内容审核（待实现）
- 支持消息推送（待实现）

## 13. 测试

### 13.1 单元测试

```bash
pytest tests/
```

### 13.2 集成测试

- 使用 TestClient 测试 API 接口
- 使用测试数据库隔离测试数据

## 14. 开发规范

### 14.1 代码风格

- 遵循 PEP 8
- 使用类型注解
- 函数文档字符串

### 14.2 Git 提交规范

- `feat:` 新功能
- `fix:` 修复问题
- `docs:` 文档更新
- `refactor:` 代码重构
- `test:` 测试相关

## 15. 已知限制

1. **AI 服务**：当前使用 Mock 数据，需接入真实 AI 模型
2. **缓存**：Redis 已配置但未使用，Feed 查询未缓存
3. **认证**：使用临时 Header 方式，需升级为 Token 认证
4. **限流**：未实现请求限流，需接入限流中间件
5. **监控**：指标数据仅存储，未接入可视化 Dashboard

## 16. 后续规划

1. **M1（已完成）**：打通 Gateway → Content → 数据库，返回真实视频列表
2. **M2（进行中）**：补齐互动、评论、AI 推荐/问答
3. **M3（待实现）**：接入 Observability，输出播放/接口指标 Dashboard
4. **M4（待实现）**：接入真实 AI 模型，优化推荐算法
5. **M5（待实现）**：实现用户系统、内容审核、消息推送

