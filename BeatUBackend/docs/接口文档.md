# BeatU Backend API 接口文档

## 基础信息

- **Base URL**: `http://127.0.0.1:8000/api`（开发环境）
- **生产环境**: `https://api.beatu.com/api`（待配置）
- **API 版本**: v1
- **数据格式**: JSON

## 通用约定

### 请求头

| Header | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | String | 是 | `application/json` |
| X-User-Id | String | 否 | 用户 ID（临时认证，默认：`demo-user`） |
| X-User-Name | String | 否 | 用户名称（临时认证，默认：`BeatU 用户`） |

### 响应格式

所有接口统一返回以下格式：

```json
{
  "code": 0,
  "message": "OK",
  "data": {}
}
```

### 错误码

| code | message | HTTP 状态码 | 说明 |
|------|---------|-------------|------|
| 0 | OK | 200 | 成功 |
| 1001 | 鉴权失败 | 401 | 缺少或无效的认证信息 |
| 2001 | 视频不存在 | 404 | 请求的视频资源不存在 |
| 2002 | 互动状态冲突 | 409 | 重复操作（如重复点赞） |
| 3001 | AI 服务不可用 | 503 | AI 服务暂时不可用 |
| 5000 | 服务器内部错误 | 500 | 服务器未知错误 |

### 分页参数

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| page | Integer | 否 | 1 | 页码，从 1 开始 |
| limit | Integer | 否 | 10 | 每页数量，最大 50 |

---

## 1. 视频接口

### 1.1 获取视频列表

**接口**: `GET /videos`

**描述**: 分页获取视频列表，支持按方向（竖屏/横屏）和频道筛选。

**请求参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | Integer | 否 | 页码，默认 1 |
| limit | Integer | 否 | 每页数量，默认 10，最大 50 |
| orientation | String | 否 | 视频方向：`portrait`（竖屏）或 `landscape`（横屏） |
| channel | String | 否 | 频道：`recommend`（推荐）或 `follow`（关注） |

**请求示例**:

```bash
GET /api/videos?page=1&limit=10&orientation=portrait&channel=recommend
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "items": [
      {
        "id": "video_001",
        "playUrl": "https://cdn.beatu.com/videos/video_001.mp4",
        "coverUrl": "https://cdn.beatu.com/covers/video_001.jpg",
        "title": "精彩视频标题",
        "tags": ["搞笑", "娱乐"],
        "durationMs": 60000,
        "orientation": "portrait",
        "authorId": "user_001",
        "authorName": "作者名称",
        "authorAvatar": "https://cdn.beatu.com/avatars/user_001.jpg",
        "likeCount": 1234,
        "commentCount": 567,
        "favoriteCount": 89,
        "shareCount": 12,
        "viewCount": 10000,
        "isLiked": false,
        "isFavorited": false,
        "isFollowedAuthor": false,
        "qualities": [
          {
            "label": "1080P",
            "bitrate": 5000,
            "resolution": "1920x1080",
            "url": "https://cdn.beatu.com/videos/video_001_1080p.mp4"
          }
        ]
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 10
  }
}
```

### 1.2 获取视频详情

**接口**: `GET /videos/{video_id}`

**描述**: 根据视频 ID 获取视频详细信息。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| video_id | String | 是 | 视频 ID |

**请求示例**:

```bash
GET /api/videos/video_001
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "id": "video_001",
    "playUrl": "https://cdn.beatu.com/videos/video_001.mp4",
    "coverUrl": "https://cdn.beatu.com/covers/video_001.jpg",
    "title": "精彩视频标题",
    "tags": ["搞笑", "娱乐"],
    "durationMs": 60000,
    "orientation": "portrait",
    "authorId": "user_001",
    "authorName": "作者名称",
    "authorAvatar": "https://cdn.beatu.com/avatars/user_001.jpg",
    "likeCount": 1234,
    "commentCount": 567,
    "favoriteCount": 89,
    "shareCount": 12,
    "viewCount": 10000,
    "isLiked": false,
    "isFavorited": false,
    "isFollowedAuthor": false,
    "qualities": []
  }
}
```

**错误响应**:

```json
{
  "code": 2001,
  "message": "视频不存在",
  "data": null
}
```

---

## 2. 互动接口

### 2.1 点赞/取消点赞

**接口**: `POST /videos/{video_id}/like`

**描述**: 对视频进行点赞或取消点赞操作。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| video_id | String | 是 | 视频 ID |

**请求体**:

```json
{
  "action": "LIKE"  // 或 "UNLIKE"
}
```

**请求示例**:

```bash
POST /api/videos/video_001/like
Content-Type: application/json
X-User-Id: user_123

{
  "action": "LIKE"
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "success": true,
    "message": "OK"
  }
}
```

**错误响应**:

```json
{
  "code": 2002,
  "message": "互动状态冲突",
  "data": null
}
```

### 2.2 收藏/取消收藏

**接口**: `POST /videos/{video_id}/favorite`

**描述**: 对视频进行收藏或取消收藏操作。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| video_id | String | 是 | 视频 ID |

**请求体**:

```json
{
  "action": "SAVE"  // 或 "REMOVE"
}
```

**请求示例**:

```bash
POST /api/videos/video_001/favorite
Content-Type: application/json
X-User-Id: user_123

{
  "action": "SAVE"
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "success": true,
    "message": "OK"
  }
}
```

### 2.3 关注/取消关注作者

**接口**: `POST /follow`

**描述**: 关注或取消关注视频作者。

**请求体**:

```json
{
  "authorId": "user_001",
  "action": "FOLLOW"  // 或 "UNFOLLOW"
}
```

**请求示例**:

```bash
POST /api/follow
Content-Type: application/json
X-User-Id: user_123

{
  "authorId": "user_001",
  "action": "FOLLOW"
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "success": true,
    "message": "关注成功"
  }
}
```

---

## 3. 评论接口

### 3.1 获取评论列表

**接口**: `GET /videos/{video_id}/comments`

**描述**: 分页获取视频的评论列表。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| video_id | String | 是 | 视频 ID |

**查询参数**:

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| page | Integer | 否 | 1 | 页码 |
| limit | Integer | 否 | 20 | 每页数量，最大 100 |

**请求示例**:

```bash
GET /api/videos/video_001/comments?page=1&limit=20
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "items": [
      {
        "id": "1",
        "videoId": "video_001",
        "authorId": "user_123",
        "authorName": "评论者名称",
        "authorAvatar": "https://cdn.beatu.com/avatars/user_123.jpg",
        "content": "这个视频太精彩了！",
        "createdAt": "2024-01-01T12:00:00Z",
        "isAiReply": false,
        "aiModel": null,
        "aiSource": null,
        "aiConfidence": null,
        "likeCount": 10
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 20
  }
}
```

### 3.2 创建评论

**接口**: `POST /videos/{video_id}/comments`

**描述**: 对视频发表评论，支持回复其他评论。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| video_id | String | 是 | 视频 ID |

**请求体**:

```json
{
  "content": "这个视频太精彩了！",
  "replyTo": "1"  // 可选，回复的评论 ID
}
```

**请求示例**:

```bash
POST /api/videos/video_001/comments
Content-Type: application/json
X-User-Id: user_123
X-User-Name: 用户名

{
  "content": "这个视频太精彩了！",
  "replyTo": "1"
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "id": "2",
    "videoId": "video_001",
    "authorId": "user_123",
    "authorName": "用户名",
    "authorAvatar": null,
    "content": "这个视频太精彩了！",
    "createdAt": "2024-01-01T12:00:00Z",
    "isAiReply": false,
    "aiModel": null,
    "aiSource": null,
    "aiConfidence": null,
    "likeCount": 0
  }
}
```

### 3.3 AI 评论（@元宝）

**接口**: `POST /videos/{video_id}/comments/ai`

**描述**: 触发 AI 助手（@元宝）生成评论回复。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| video_id | String | 是 | 视频 ID |

**请求体**:

```json
{
  "question": "这个视频讲了什么？"
}
```

**请求示例**:

```bash
POST /api/videos/video_001/comments/ai
Content-Type: application/json

{
  "question": "这个视频讲了什么？"
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "id": "3",
    "videoId": "video_001",
    "authorId": "ai_beatu",
    "authorName": "@元宝",
    "authorAvatar": null,
    "content": "关于《video_001》：这个视频讲了什么？。建议继续关注剧情发展，更多彩蛋等你发现。",
    "createdAt": "2024-01-01T12:00:00Z",
    "isAiReply": true,
    "aiModel": "beatu-mini",
    "aiSource": "qa",
    "aiConfidence": 0.87,
    "likeCount": 0
  }
}
```

---

## 4. AI 能力接口

### 4.1 视频推荐

**接口**: `POST /ai/recommend`

**描述**: 基于当前视频播放情况，推荐下一批视频。

**请求体**:

```json
{
  "videoId": "video_001",
  "dwellMs": 60000,
  "consumedDurationMs": 55000,
  "tags": ["搞笑", "娱乐"]  // 可选
}
```

**请求示例**:

```bash
POST /api/ai/recommend
Content-Type: application/json

{
  "videoId": "video_001",
  "dwellMs": 60000,
  "consumedDurationMs": 55000,
  "tags": ["搞笑", "娱乐"]
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "nextVideos": [
      {
        "id": "video_002",
        "playUrl": "https://cdn.beatu.com/videos/video_002.mp4",
        "coverUrl": "https://cdn.beatu.com/covers/video_002.jpg",
        "title": "推荐视频标题",
        "tags": ["搞笑"],
        "durationMs": 45000,
        "orientation": "portrait",
        "authorId": "user_002",
        "authorName": "作者名称",
        "authorAvatar": null,
        "likeCount": 500,
        "commentCount": 100,
        "favoriteCount": 50,
        "shareCount": 10,
        "viewCount": 5000,
        "isLiked": false,
        "isFavorited": false,
        "isFollowedAuthor": false,
        "qualities": []
      }
    ],
    "reason": "结合播放完成度与兴趣标签，为你准备的下一支好片"
  }
}
```

### 4.2 清晰度建议

**接口**: `POST /ai/quality`

**描述**: 根据网络和设备状态，建议合适的视频清晰度。

**请求体**:

```json
{
  "videoId": "video_001",
  "networkStats": {
    "bandwidthKbps": 5000,
    "latencyMs": 50,
    "packetLoss": 0.01
  },
  "deviceStats": {
    "cpuLoad": 0.3,
    "gpuLoad": 0.2,
    "batteryLevel": 0.8,
    "temperature": 35
  }
}
```

**请求示例**:

```bash
POST /api/ai/quality
Content-Type: application/json

{
  "videoId": "video_001",
  "networkStats": {
    "bandwidthKbps": 5000,
    "latencyMs": 50,
    "packetLoss": 0.01
  },
  "deviceStats": {
    "cpuLoad": 0.3,
    "gpuLoad": 0.2,
    "batteryLevel": 0.8,
    "temperature": 35
  }
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "quality": "1080P",
    "reason": "网络 5000kbps，选择 1080P 以平衡清晰度与流畅度"
  }
}
```

**清晰度规则**:

- `bandwidthKbps > 8000` → `4K`
- `bandwidthKbps > 5000` → `1080P`
- `bandwidthKbps > 2500` → `720P`
- 其他 → `AUTO`

### 4.3 AI 问答

**接口**: `POST /ai/comment/qa`

**描述**: AI 问答接口，生成 AI 评论并入库。

**请求体**:

```json
{
  "videoId": "video_001",
  "question": "这个视频的亮点是什么？"
}
```

**请求示例**:

```bash
POST /api/ai/comment/qa
Content-Type: application/json

{
  "videoId": "video_001",
  "question": "这个视频的亮点是什么？"
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "comment": {
      "id": "4",
      "videoId": "video_001",
      "authorId": "ai_beatu",
      "authorName": "@元宝",
      "authorAvatar": null,
      "content": "关于《video_001》：这个视频的亮点是什么？。建议继续关注剧情发展，更多彩蛋等你发现。",
      "createdAt": "2024-01-01T12:00:00Z",
      "isAiReply": true,
      "aiModel": "beatu-mini",
      "aiSource": "qa",
      "aiConfidence": 0.87,
      "likeCount": 0
    }
  }
}
```

---

## 5. 观测性接口

### 5.1 播放指标上报

**接口**: `POST /metrics/playback`

**描述**: 客户端上报视频播放相关指标。

**请求体**:

```json
{
  "videoId": "video_001",
  "fps": 30.0,
  "startUpMs": 500,
  "rebufferCount": 2,
  "memoryMb": 150.5,
  "channel": "recommend"
}
```

**请求示例**:

```bash
POST /api/metrics/playback
Content-Type: application/json

{
  "videoId": "video_001",
  "fps": 30.0,
  "startUpMs": 500,
  "rebufferCount": 2,
  "memoryMb": 150.5,
  "channel": "recommend"
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "success": true
  }
}
```

### 5.2 互动指标上报

**接口**: `POST /metrics/interaction`

**描述**: 客户端上报互动相关指标。

**请求体**:

```json
{
  "event": "like",
  "videoId": "video_001",
  "latencyMs": 150,
  "success": true
}
```

**请求示例**:

```bash
POST /api/metrics/interaction
Content-Type: application/json

{
  "event": "like",
  "videoId": "video_001",
  "latencyMs": 150,
  "success": true
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "success": true
  }
}
```

---

## 6. 数据模型

### 6.1 VideoItem（视频项）

```typescript
interface VideoItem {
  id: string;                    // 视频 ID
  playUrl: string;               // 播放地址
  coverUrl: string;              // 封面地址
  title: string;                 // 标题
  tags: string[];                // 标签列表
  durationMs: number;            // 时长（毫秒）
  orientation: "portrait" | "landscape";  // 方向
  authorId: string;              // 作者 ID
  authorName: string;            // 作者名称
  authorAvatar?: string;         // 作者头像
  likeCount: number;             // 点赞数
  commentCount: number;          // 评论数
  favoriteCount: number;         // 收藏数
  shareCount: number;            // 分享数
  viewCount: number;             // 播放数
  isLiked: boolean;              // 是否已点赞
  isFavorited: boolean;          // 是否已收藏
  isFollowedAuthor: boolean;     // 是否已关注作者
  qualities: VideoQuality[];     // 多码率信息
}
```

### 6.2 VideoQuality（视频清晰度）

```typescript
interface VideoQuality {
  label: string;                 // 清晰度标签（如 "1080P"）
  bitrate?: number;              // 码率（kbps）
  resolution?: string;           // 分辨率（如 "1920x1080"）
  url: string;                   // 对应码率的播放地址
}
```

### 6.3 CommentItem（评论项）

```typescript
interface CommentItem {
  id: string;                    // 评论 ID
  videoId: string;               // 视频 ID
  authorId: string;              // 评论者 ID
  authorName: string;            // 评论者名称
  authorAvatar?: string;         // 评论者头像
  content: string;                // 评论内容
  createdAt: string;             // 创建时间（ISO 8601）
  isAiReply: boolean;            // 是否为 AI 回复
  aiModel?: string;              // AI 模型标识
  aiSource?: string;             // AI 来源
  aiConfidence?: number;         // AI 置信度（0-1）
  likeCount: number;             // 点赞数
}
```

---

## 7. 接口测试

### 7.1 使用 Swagger UI

启动服务后，访问 `http://127.0.0.1:8000/docs` 查看交互式 API 文档。

### 7.2 使用 curl

```bash
# 获取视频列表
curl -X GET "http://127.0.0.1:8000/api/videos?page=1&limit=10" \
  -H "X-User-Id: user_123"

# 点赞视频
curl -X POST "http://127.0.0.1:8000/api/videos/video_001/like" \
  -H "Content-Type: application/json" \
  -H "X-User-Id: user_123" \
  -d '{"action": "LIKE"}'

# 创建评论
curl -X POST "http://127.0.0.1:8000/api/videos/video_001/comments" \
  -H "Content-Type: application/json" \
  -H "X-User-Id: user_123" \
  -H "X-User-Name: 用户名" \
  -d '{"content": "这个视频太精彩了！"}'
```

### 7.3 使用 Postman

1. 导入 Postman Collection（待提供）
2. 设置环境变量：`BASE_URL = http://127.0.0.1:8000/api`
3. 设置 Header：`X-User-Id` 和 `X-User-Name`

---

## 8. 注意事项

1. **认证**：当前使用临时 Header 方式，生产环境需升级为 Token 认证
2. **限流**：未实现请求限流，建议接入限流中间件
3. **缓存**：Feed 查询未使用缓存，建议接入 Redis 缓存
4. **AI 服务**：当前使用 Mock 数据，需接入真实 AI 模型
5. **错误处理**：部分错误可能返回 500，建议完善错误处理机制

---

## 9. 更新日志

- **v0.1.0** (2024-01-01): 初始版本，实现核心接口
  - 视频列表/详情接口
  - 互动接口（点赞/收藏/关注）
  - 评论接口（列表/创建/AI）
  - AI 能力接口（推荐/清晰度/问答）
  - 观测性接口（播放/互动指标）

