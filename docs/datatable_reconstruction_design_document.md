## 1.背景

在后端项目功能扩展后，原有的 Mock 数据已经不再满足实际业务场景需求。客户端数据库需要正式对接后端数据库，实现以下能力：

与后端真实数据源连通

支持数据拉取、展示、同步、定期删除

结合真实业务流程，重新设计本地数据库与后端数据库结构

清晰定义接口对接、缓存策略、刷新机制

确保各模块成员对“数据库表重构 + 扩展后项目的业务流程”达成共同理解

### 共识

1. APP的使用用户：用户名(唯一)：BEATU

2. **远程：完整真数据** **本地：小量缓存 +** **UI** **必需数据 + 快速状态标记**

3. 渲染逻辑：数据先取出，再渲染：后端把所有数据（视频列表、用户数据……）先塞到客户端本地数据库，然后界面再从本地数据库读出来显示

4. 修改数据（乐观更新）：

    1. 动作：修改个人信息，用户-视频互动，用户-用户关注，观看历史，写评论

    2. 修改客户端数据库，UI直接显示，异步线程发送后端请求，后端成功（200 OK）

    3. 后端失败：

        1. 策略 A：**回滚** **UI****，提示用户后端操作失败**（本地 isPending = true，重试次数达上限 → 回滚本地修改 → UI 恢复原状态）（适用于社交重要动作）

            1. 适用：点赞/取消点赞，收藏/取消收藏，关注/取消关注，评论发送

        2. 策略 B：**不回滚**（适用于播放历史）

            1. 观看历史属于 **弱一致性** 数据，local_watch_history.isPending = true，下次启动 / 空闲时自动重试同步

5. APP启动：

    1. 核心原则：不阻塞首屏显示；后台更新数据，UI渐进刷新；本地未同步数据优先上传，保证数据一致性；可选提示微动画，不打断用户操作

    2. 第一次启动：

        1. 同步加载（首屏必要数据），首页分页视频列表，本人用户信息，已点赞 / 已收藏状态（用户-视频互动）

        2. 延迟异步加载（可延迟，不阻塞首屏）；用户-用户关注状态；历史观看记录；评论内容（可先显示空或默认占位）

        3. 如果点击时异步没更新，则 UI 占位 + Loading 指示，等待异步数据更新完成

    3. 视频看完后下拉刷新/搜索：同步加载新的视频列表；异步刷新点赞/收藏状态、评论、关注

    4. 之后的启动：异步扫描数据库表是否有没更新到远程数据库的，发送请求，更新，不提示用户；异步刷新视频列表，关注 Feed 视频，用户信息（本人），观看历史


## 2.数据库表

|   |   |   |   |   |
|---|---|---|---|---|
||**表名**|**必须？**|**客户端？/后端 ？**|**作用**|
|视频内容|beatu_video|✔|**客户端 & 后端**|1.视频播放（主页Feed / 关注Feed / 个人主页点击视频列表/ 作者信息弹窗点击视频列表 / 搜索点击视频列表 ）<br><br>2.视频数据（个人页的视频列表展示）|
|用户信息|beatu_user|✔|**客户端 & 后端**|1.用户信息（个人主页 / 作者信息弹窗）|
|用户-视频互动|beatu_video_interaction|✔|**客户端 & 后端**|1.用户与视频的互动状态交互（点赞按钮 / 收藏按钮）|
|用户-用户关注|beatu_user_follow|✔|**客户端 & 后端**|1.用户与用户的关注状态（作者信息弹窗的关注按钮）<br><br>2.关注Feed的视频读取|
|观看历史|beatu_watch_history|✔|**客户端 & 后端**|1.个人主页的历史观看的视频列表<br><br>2.主页的视频返回从上次时间开始播放|
|评论内容|beatu_comment||**后端**|1.评论弹窗的数据显示|
|搜索历史|beatu_search_history|持久化（0~5），LRU策略|**客户端**|1.搜索界面的提醒|

## 3.具体库表

### **表：beatu_video**

|   |   |
|---|---|
|字段|说明|
|videoId (PK)|视频 ID|
|playUrl|播放地址|
|coverUrl|封面地址|
|title|视频标题|
|authorId|作者 ID|
|orientation|横屏/竖屏|
|durationMs|视频时长（毫秒）|
|likeCount|点赞数|
|commentCount|评论数|
|favoriteCount|收藏数|
|viewCount|观看次数|
|authorAvatar|作者头像|
|shareUrl|分享链接|

### **表：beatu_user**

|   |   |
|---|---|
|字段|说明|
|userId (PK)|用户 ID|
|userName（unique）|用户昵称（唯一）|
|avatarUrl|头像 URL|
|followerCount|粉丝数|
|followingCount|关注数|
|bio|简介|

### **表：beatu_video_interaction**

|   |   |   |
|---|---|---|
|字段|说明|主键/备注|
|videoId|视频 ID|PK（复合主键）|
|userId|用户 ID|PK（复合主键）|
|isLiked|是否点赞|0/1|
|isFavorited|是否收藏|0/1|
|isPending|本地待同步状态|0/1|

**策略说明**：

- 点赞/收藏失败 → 回滚 UI，`isPending = false`，`retryCount` 到上限则回滚。


### **表：beatu_user_follow**

|   |   |   |
|---|---|---|
|字段|说明|主键/备注|
|userId|当前用户 ID|PK（复合主键）|
|authorId|被关注的作者 ID|PK（复合主键）|
|isFollowed|是否关注|0/1|
|isPending|本地待同步状态|0/1|

**策略说明**：

- 关注/取消关注失败 → 回滚 UI。


### **表：beatu_watch_history**

|   |   |
|---|---|
|字段|说明|
|videoId (PK)|视频 ID|
|userId (PK)|用户 ID|
|lastPlayPositionMs|上次播放进度（用于“从上次播放继续”）|
|watchedAt|最后观看时间（排序用）|

### **表：beatu_comment**

|   |   |   |
|---|---|---|
|字段|说明|主键/备注|
|commentId|评论 ID|PK|
|videoId|所属视频 ID||
|authorId|评论作者||
|content|评论内容||
|createdAt|评论时间||
|likeCount|点赞数||
|isLiked|是否点赞|0/1|
|isPending|本地待同步状态|0/1|
|authorAvatar|作者头像||

**策略说明**：

- 评论发送失败 → 删除本地待同步评论或回滚 UI。


### **表：beatu_search_history**

|   |   |
|---|---|
|搜索历史|说明|
|query|搜索词|
|createdAt|搜索时间|
|userId|用户 ID|