# 1. 背景

在后端项目功能扩展后，原有的 Mock 数据已经不再满足实际业务场景需求。客户端数据库需要正式对接后端数据库，实现以下能力：

- 与后端真实数据源连通
- 支持数据拉取、展示、同步、定期删除
- 结合真实业务流程，重新设计本地数据库与后端数据库结构
- 清晰定义接口对接、缓存策略、刷新机制
- 确保各模块成员对“数据库表重构 + 扩展后项目的业务流程”达成共同理解

## 共识

1. **APP的使用用户**：用户名(唯一)：BEATU
2. **远程 / 本地策略**
    - 远程：完整真数据
    - 本地：小量缓存 + UI 必需数据 + 快速状态标记
3. **数据读取流程**
    - 数据先取出，再渲染：后端把所有数据（视频列表、用户数据等）先塞到客户端本地数据库，然后界面再从本地数据库读出来显示
4. **修改数据（乐观更新）**
    - 动作：
        - 修改个人信息
        - 用户-视频互动（点赞、收藏）
        - 用户-用户关注
        - 观看历史
        - 写评论
    - 流程：
        1. 修改客户端数据库，UI直接显示
        2. 异步线程发送后端请求
        3. 后端返回成功（200 OK）
    - 后端失败策略：
        - **策略 A（回滚 UI）**：适用于社交重要动作
            - 点赞/取消点赞、收藏/取消收藏、关注/取消关注、评论发送
            - 本地标记 `isPending = true`，重试次数达上限 → 回滚本地修改 → UI 恢复原状态
        - **策略 B（不回滚）**：适用于播放历史
            - 观看历史属于弱一致性数据，本地标记 `local_watch_history.isPending = true`
            - 下次启动 / 空闲时自动重试同步
5. **APP 启动流程**
    1. **核心原则**：不阻塞首屏显示；后台更新数据，UI渐进刷新；本地未同步数据优先上传，保证数据一致性
    2. **第一次启动**
        - 同步加载首屏必要数据：
            - 首页分页视频列表
            - 本人用户信息
            - 已点赞 / 已收藏状态（用户-视频互动）
        - 延迟异步加载（可延迟，不阻塞首屏）：
            - 用户-用户关注状态
            - 历史观看记录
            - 评论内容（可先显示空或占位）
        - 点击时异步未更新 → UI 占位 + Loading 指示，等待异步数据更新完成
    3. **视频观看后刷新/搜索**
        - 同步加载新的视频列表
        - 异步刷新点赞/收藏状态、评论、关注
    4. **之后启动**
        - 异步扫描本地数据库表是否有未同步到远程的数据 → 自动上传 / 不提示用户
        - 异步刷新视频列表、关注 Feed 视频、本人信息、观看历史

---

# 2. 数据库表设计

| 表名 | 必须 | 存储位置 | 作用 |
|------|------|----------|------|
| `video` | ✔ | 客户端 & 后端 | 视频播放（主页Feed / 关注Feed / 个人主页视频列表 / 搜索结果） |
| `user` | ✔ | 客户端 & 后端 | 用户信息（个人主页 / 作者信息弹窗） |
| `video_interaction` | ✔ | 客户端 & 后端 | 用户与视频的互动状态（点赞、收藏按钮） |
| `user_follow` | ✔ | 客户端 & 后端 | 用户与用户的关注状态（作者信息弹窗、关注 Feed 视频） |
| `watch_history` | ✔ | 客户端 & 后端 | 历史观看视频列表；主页视频从上次时间开始播放 |
| `comment` | 可选 | 客户端？/后端 todo | 评论弹窗显示内容，本地可缓存 1~3 条视频评论 |
| `search_history` | ✔ | 客户端 | 搜索界面提醒，持久化 0~5 条，LRU 策略 |

---

# 3. 具体策略说明

## 视频互动（点赞 / 收藏）
- 失败 → 回滚 UI
- 本地标记 `isPending = false`，重试次数达上限 → 回滚本地修改 → UI 恢复原状态

## 用户关注（关注 / 取消关注）
- 失败 → 回滚 UI

## 评论发送
- 失败 → 删除本地待同步评论或回滚 UI

## 观看历史
- 弱一致性数据 → 不回滚
- `local_watch_history.isPending = true`，后台异步重试

---

# 4. 数据读取原则

1. **首屏展示必要数据** → 本地数据库 + 异步刷新
2. **轻量化缓存** → 本地只存 UI 必需数据 & 状态标记
3. **乐观更新** → UI 立即更新，本地标记待同步，后台异步同步
4. **后台任务** → 定期扫描本地未同步数据 → 上传后端
