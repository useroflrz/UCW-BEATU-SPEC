# 云服务器配置说明

本文档说明将后端和数据库迁移到云服务器后需要修改的配置，以及如何切换回本地后端。

## 📋 目录

- [云服务器配置更改](#云服务器配置更改)
- [切换回本地后端](#切换回本地后端)
- [配置验证](#配置验证)
- [常见问题](#常见问题)

---

## 🌐 云服务器配置更改

### 一、客户端配置（BeatUClient）

#### 1. 后端API地址配置

**文件路径**: `BeatUClient/app/src/main/res/values/config.xml`

**修改内容**:
```xml
<!-- 修改前（本地开发） -->
<string name="base_url">http://192.168.31.72:9306/</string>

<!-- 修改后（云服务器） -->
<string name="base_url">http://8.136.42.115:9306/</string>
```

**说明**:
- 这是客户端连接后端服务的地址
- 修改后需要重新编译并运行应用才能生效
- 确保云服务器的 9306 端口已开放防火墙

---

### 二、后端配置（BeatUBackend）

#### 1. 数据库连接配置

**文件路径**: `BeatUBackend/core/config.py`

**修改内容**:
- 修改了 `database_url` 的默认值
- 添加了 `build_database_url()` 函数，支持从分离的数据库变量构建连接字符串

**配置优先级**（从高到低）:
1. `DATABASE_URL` 环境变量
2. `.env` 文件中的 `DATABASE_URL`
3. 从 `.env` 文件中的分离变量构建（`DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`）
4. `config.py` 中的默认值

**当前云服务器配置**:
```python
# 默认值（如果环境变量和 .env 都没有设置）
default="mysql+pymysql://beatu:RXSSbTkGZWFkyThj@localhost:3306/beatu"
```

#### 2. .env 文件配置

**文件路径**: `BeatUBackend/.env`

**推荐配置方式**（两种方式任选其一）:

**方式1：使用 DATABASE_URL（推荐）**
```bash
DATABASE_URL=mysql+pymysql://beatu:RXSSbTkGZWFkyThj@localhost:3306/beatu
```

**方式2：使用分离的变量**
```bash
DB_HOST=localhost
DB_PORT=3306
DB_USER=beatu
DB_PASSWORD=RXSSbTkGZWFkyThj
DB_NAME=beatu
```

**说明**:
- 如果数据库与后端在同一台云服务器上，使用 `localhost`
- 如果数据库在另一台服务器上，使用数据库服务器的 IP 地址
- `.env` 文件不会被提交到 Git（已在 `.gitignore` 中）

#### 3. 请求日志中间件

**文件路径**: `BeatUBackend/core/middleware.py`（新增）

**功能**:
- 记录所有 API 请求的详细信息
- 包括请求方法、路径、客户端IP、查询参数
- 记录响应状态码和处理时间

**日志示例**:
```
[请求] GET /api/videos | 客户端IP: 123.456.789.0 | 查询参数: {'page': '1'}
[响应] GET /api/videos | 状态码: 200 | 处理时间: 0.123秒 | 客户端IP: 123.456.789.0
```

#### 4. 健康检查接口

**文件路径**: `BeatUBackend/main.py`

**新增接口**: `GET /health`

**功能**:
- 快速验证后端服务是否正常运行
- 返回服务状态和版本信息

**响应示例**:
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T10:00:00",
  "service": "BeatU Backend",
  "version": "0.1.0"
}
```

---

## 🔄 切换回本地后端

### 一、客户端配置

#### 1. 修改后端API地址

**文件路径**: `BeatUClient/app/src/main/res/values/config.xml`

**修改为本地地址**:
```xml
<!-- 云服务器地址 -->
<string name="base_url">http://8.136.42.115:9306/</string>

<!-- 本地开发地址（根据实际情况修改） -->
<string name="base_url">http://192.168.31.72:9306/</string>
<!-- 或者使用 localhost（仅限模拟器） -->
<string name="base_url">http://10.0.2.2:9306/</string>
```

**说明**:
- `192.168.31.72` 替换为你本地机器的 IP 地址
- 如果使用 Android 模拟器，使用 `10.0.2.2` 访问宿主机
- 如果使用真机，使用电脑的局域网 IP 地址

---

### 二、后端配置

#### 1. 修改数据库连接

**方式1：修改 .env 文件（推荐）**

**文件路径**: `BeatUBackend/.env`

```bash
# 云服务器配置
DATABASE_URL=mysql+pymysql://beatu:RXSSbTkGZWFkyThj@localhost:3306/beatu

# 本地开发配置（根据实际情况修改）
DATABASE_URL=mysql+pymysql://jeecg:haomo123@192.168.1.206:3306/jeecg-boot3
```

**方式2：设置环境变量**

```bash
# Windows PowerShell
$env:DATABASE_URL="mysql+pymysql://jeecg:haomo123@192.168.1.206:3306/jeecg-boot3"

# Linux/Mac
export DATABASE_URL="mysql+pymysql://jeecg:haomo123@192.168.1.206:3306/jeecg-boot3"
```

**方式3：修改 config.py 默认值**

**文件路径**: `BeatUBackend/core/config.py`

```python
database_url: str = Field(
    # 云服务器默认值
    # default="mysql+pymysql://beatu:RXSSbTkGZWFkyThj@localhost:3306/beatu",
    
    # 本地开发默认值（根据实际情况修改）
    default="mysql+pymysql://jeecg:haomo123@192.168.1.206:3306/jeecg-boot3",
    description="数据库连接URL，格式：mysql+pymysql://用户名:密码@主机:端口/数据库名"
)
```

#### 2. 启动本地后端服务

```bash
# 激活虚拟环境
conda activate beatu-backend
# 或
source venv/bin/activate

# 启动服务
uvicorn main:app --reload --host 0.0.0.0 --port 9306
```

**说明**:
- `--reload`: 开发模式，代码修改后自动重启
- `--host 0.0.0.0`: 允许外部访问（局域网内其他设备可以访问）
- `--port 9306`: 服务端口

---

## ✅ 配置验证

### 一、验证客户端配置

#### 1. 检查配置文件

确认 `config.xml` 中的 `base_url` 是否正确：

```bash
# 查看配置文件
cat BeatUClient/app/src/main/res/values/config.xml
```

#### 2. 在应用中查看日志

在 Android Studio 的 Logcat 中搜索 `Network` 标签，应该能看到：

```
D/Network: ➡️ GET http://8.136.42.115:9306/api/videos?page=1
D/Network: ⬅️ 200 http://8.136.42.115:9306/api/videos?page=1
```

### 二、验证后端配置

#### 1. 检查数据库连接

```bash
# 在云服务器上测试数据库连接
mysql -u beatu -pRXSSbTkGZWFkyThj -h localhost beatu

# 或查看视频数量
mysql -u beatu -pRXSSbTkGZWFkyThj -h localhost beatu -e "SELECT COUNT(*) FROM beatu_videos;"
```

#### 2. 检查后端服务

```bash
# 测试健康检查接口
curl http://8.136.42.115:9306/health

# 测试视频列表接口
curl "http://8.136.42.115:9306/api/videos?page=1&limit=10"
```

#### 3. 查看后端日志

在云服务器上查看后端日志，应该能看到请求日志：

```bash
# 如果使用 nohup 启动
tail -f nohup.out

# 如果使用 systemd
journalctl -u beatu-backend -f

# 如果直接运行，查看控制台输出
```

---

## ❓ 常见问题

### Q1: 客户端无法连接到云服务器

**可能原因**:
1. 防火墙未开放 9306 端口
2. 后端服务未启动
3. 客户端配置的地址不正确

**解决方案**:
1. 检查防火墙设置：
   ```bash
   # CentOS/RHEL
   firewall-cmd --add-port=9306/tcp --permanent
   firewall-cmd --reload
   
   # Ubuntu/Debian
   ufw allow 9306/tcp
   ```

2. 检查后端服务是否运行：
   ```bash
   ps aux | grep uvicorn
   ```

3. 检查端口是否监听：
   ```bash
   netstat -tlnp | grep 9306
   # 或
   ss -tlnp | grep 9306
   ```

### Q2: 后端无法连接数据库

**可能原因**:
1. 数据库服务未启动
2. 数据库用户权限不足
3. 数据库地址配置错误

**解决方案**:
1. 检查 MySQL 服务：
   ```bash
   systemctl status mysql
   # 或
   systemctl status mariadb
   ```

2. 检查数据库用户权限：
   ```sql
   SHOW GRANTS FOR 'beatu'@'localhost';
   ```

3. 检查配置：
   ```bash
   # 查看当前使用的配置
   python3 -c "from core.config import settings; print(settings.database_url)"
   ```

### Q3: 修改配置后不生效

**解决方案**:
1. **客户端**: 重新编译并运行应用
2. **后端**: 重启后端服务
   ```bash
   # 停止当前服务（Ctrl+C）
   # 重新启动
   uvicorn main:app --host 0.0.0.0 --port 9306
   ```

### Q4: 如何查看详细的错误日志

**客户端日志**:
- Android Studio → Logcat → 搜索 `VideoRepository` 或 `VideoRemoteDataSource`

**后端日志**:
- 查看控制台输出或日志文件
- 搜索 `[请求]` 或 `[响应]` 标签

### Q5: 数据库在不同服务器上如何配置

如果数据库在另一台服务器上（不是 localhost）：

**修改 .env 文件**:
```bash
DATABASE_URL=mysql+pymysql://beatu:RXSSbTkGZWFkyThj@数据库服务器IP:3306/beatu
```

**确保**:
1. 数据库服务器允许远程连接
2. 防火墙开放 3306 端口
3. 数据库用户有远程访问权限：
   ```sql
   GRANT ALL PRIVILEGES ON beatu.* TO 'beatu'@'%' IDENTIFIED BY 'RXSSbTkGZWFkyThj';
   FLUSH PRIVILEGES;
   ```

---

## 📝 配置清单

### 云服务器配置清单

- [ ] 客户端 `config.xml` 中的 `base_url` 已修改为云服务器地址
- [ ] 后端 `.env` 文件中的数据库配置已设置
- [ ] 数据库服务正在运行
- [ ] 后端服务正在运行
- [ ] 防火墙已开放 9306 端口
- [ ] 客户端可以访问健康检查接口：`http://云服务器IP:9306/health`
- [ ] 客户端可以获取视频列表数据

### 切换回本地后端清单

- [ ] 客户端 `config.xml` 中的 `base_url` 已修改为本地地址
- [ ] 后端 `.env` 文件中的数据库配置已修改为本地数据库
- [ ] 本地数据库服务正在运行
- [ ] 本地后端服务已启动
- [ ] 客户端和服务器在同一网络或使用正确的 IP 地址
- [ ] 客户端可以访问本地后端服务

---

## 📚 相关文档

- [配置文件说明](../BeatUClient/CONFIG.md)
- [后端配置说明](../BeatUBackend/CONFIG.md)
- [数据层架构文档](./data-layer-architecture.md)
- [后端集成检查清单](./backend_integration_checklist.md)

---

**最后更新**: 2024-12-05
**维护者**: BeatU 开发团队

